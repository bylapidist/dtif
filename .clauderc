# Claude Configuration for DTIF

## Project Overview

This is the **Design Token Interchange Format (DTIF)** repository - a vendor-neutral JSON specification for exchanging design tokens between design tools and codebases. The project is a monorepo using npm workspaces with strict quality standards and semantic versioning.

**Key characteristics:**
- Node.js 22 (npm 10+) is required - match this locally to avoid CI drift
- Strict adherence to Semantic Versioning for all published packages
- Conventional Commits convention for all commit messages
- Changesets-based release workflow
- High code quality standards with comprehensive linting and testing

## Workspaces

The repository contains four main workspaces:

1. **schema/** - `@lapidist/dtif-schema` - Canonical JSON Schema with bundled TypeScript declarations
2. **validator/** - `@lapidist/dtif-validator` - Validation utilities wrapping Ajv with the schema
3. **parser/** - `@lapidist/dtif-parser` - Streaming parser with pointer graphs and resolver APIs
4. **language-server/** - `@lapidist/dtif-language-server` - LSP implementation for editor support

## Critical Pre-Commit Workflow

**IMPORTANT:** Before creating any commits, you MUST run and pass ALL relevant checks:

### Always Required
1. `npm install` (or `npm ci` for clean install) to ensure dependencies are current
2. `npm run format:check` - Prettier formatting validation
3. `npm run lint` - Markdown linting
4. `npm run lint:ts` - ESLint for JavaScript/TypeScript (when touching JS/TS files)
5. `npm test` - Main test suite

### Conditional Checks (based on modified files)
- **language-server/** changes: `npm run build --workspace=@lapidist/dtif-language-server && npm test --workspace=@lapidist/dtif-language-server`
- **docs/** changes: `npm run lint:docs`
- **parser/** changes: `npm run --workspace parser test`
- **schema/ or validator/** changes: `npm run build:packages` to verify generated artifacts stay in sync
- **docs/.vitepress or static content**: `npm run docs:build` before submitting

### Changeset Requirements
- **parser/** changes: Create a changeset covering `@lapidist/dtif-parser` via `npm run changeset`
- Any user-visible feature or fix: Create a changeset with `npm run changeset`
- Choose correct semver bump (patch/minor/major) for affected packages

## Code Quality Standards

### Formatting & Linting
- Use `npm run format` to apply Prettier formatting when needed
- **NEVER** disable lint rules via inline comments - code must satisfy ESLint/markdownlint without overrides
- No exceptions to linting rules - fix the underlying issue instead

### TypeScript Standards
- Prefer precise TypeScript typings
- Avoid casting to `any` or broad type assertions unless absolutely necessary
- Maintain strict type safety throughout the codebase

### Commit Message Convention
Follow Conventional Commits strictly:
- Format: `type(scope): description`
- Examples: `feat(parser): add token resolution caching`, `fix(validator): correct schema validation for refs`
- Common types: `feat`, `fix`, `docs`, `chore`, `test`, `refactor`
- Keep commits focused - avoid bundling unrelated changes

## Changesets & Release Process

1. **Creating Changesets:**
   - Run `npm run changeset` after making user-visible changes
   - Select affected packages (typically `@lapidist/dtif-schema`, `@lapidist/dtif-validator`, `@lapidist/dtif-parser`)
   - Choose appropriate semver bump (patch/minor/major)
   - Write concise summary in the changeset body
   - Keep autogenerated frontmatter intact

2. **Version Updates:**
   - `npm run version-packages` - Update package versions locally
   - This regenerates CHANGELOG.md entries

3. **Publishing:**
   - `npm run release` - Publish to npm (usually handled by CI)

## Common Development Tasks

### Running Tests
```bash
npm test                                              # Run all tests
npm run --workspace parser test                      # Parser tests only
npm test --workspace=@lapidist/dtif-language-server  # Language server tests
```

### Building Packages
```bash
npm run build:packages                                          # Build schema & validator
npm run build --workspace=@lapidist/dtif-language-server       # Build language server
```

### Documentation
```bash
npm run docs:dev      # Start local docs server
npm run docs:build    # Build static docs
npm run lint:docs     # Lint documentation
```

### Validation
```bash
npm run validate:dtif  # Validate DTIF examples in markdown
```

## File Structure Reference

- **schema/** - JSON Schema definitions
- **examples/** - Schema-valid token sets (shared across docs and tests)
- **registry/** - Canonical list of `$type` identifiers and extension namespaces
- **tests/** - Conformance fixtures and test harness
- **docs/** - VitePress documentation site
- **scripts/** - Build and validation scripts
- **.changeset/** - Changesets configuration and pending changes

## Important Guidelines for Claude Agents

### When Making Changes

1. **Always check dependencies first:**
   - Run `npm install` before starting work
   - Verify you're working with Node.js 22

2. **Understand the scope:**
   - Identify which workspace(s) you're modifying
   - Note which conditional checks will be required

3. **Test incrementally:**
   - Run relevant tests as you make changes
   - Don't wait until the end to discover test failures

4. **Create changesets appropriately:**
   - Every user-facing change needs a changeset
   - Parser changes ALWAYS need a changeset
   - Choose semver bumps carefully (breaking changes = major)

5. **Format before committing:**
   - Run `npm run format` to auto-fix formatting
   - Verify with `npm run format:check`

### When Writing Commits

1. **Follow Conventional Commits strictly** - `type(scope): description`
2. **Keep commits atomic** - one logical change per commit
3. **Write clear, descriptive messages** - explain WHY, not just WHAT

### When Stuck

If you encounter issues:
- Check if dependencies are installed: `npm install`
- Verify Node.js version: `node --version` (should be 22.x)
- Review recent commits for patterns: `git log --oneline -10`
- Run full test suite to identify failures: `npm test`
- Check build artifacts are in sync: `npm run build:packages`

## CI/CD Integration

The repository uses GitHub Actions for CI. All checks must pass:
- Formatting validation
- Linting (markdown, TypeScript)
- Full test suite
- Build verification
- Documentation build

**Never push code that fails local checks** - CI should confirm local results, not discover new failures.

## Additional Context

- License: MIT
- Registry-backed naming system for extensions
- Derives from Design Tokens Community Group format spec
- Documentation deployed at: https://dtif.lapidist.net
- Related toolkit: https://dtifx.lapidist.net/

## Quick Reference Commands

| Task | Command |
|------|---------|
| Install dependencies | `npm install` |
| Run all tests | `npm test` |
| Format code | `npm run format` |
| Check formatting | `npm run format:check` |
| Lint markdown | `npm run lint` |
| Lint TypeScript | `npm run lint:ts` |
| Build packages | `npm run build:packages` |
| Create changeset | `npm run changeset` |
| Start docs locally | `npm run docs:dev` |
| Validate examples | `npm run validate:dtif` |
