import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';
import { compileFromFile } from 'json-schema-to-typescript';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(__dirname, '..');
const schemaDir = path.join(repoRoot, 'schema');
const schemaSource = path.join(schemaDir, 'core.json');
const schemaTypesPath = path.join(schemaDir, 'index.d.ts');

const bannerComment = `/* eslint-disable */\n/**\n * This file was automatically generated by json-schema-to-typescript.\n * DO NOT MODIFY IT BY HAND. Instead, modify the source JSONSchema file,\n * and run json-schema-to-typescript to regenerate this file.\n */`;

async function main() {
  await fs.mkdir(schemaDir, { recursive: true });

  const types = await compileFromFile(schemaSource, {
    cwd: schemaDir,
    bannerComment
  });

  const output = `${types.trimEnd()}\n`;
  await fs.writeFile(schemaTypesPath, output);
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
